#include "myutils.h"
#include "mx.h"
#include "alpha.h"
#include <mutex>

Mx<float> g_SubstMxf;
float **g_SubstMx;

float B62_S_ij[20][20] = {
//        A       C       D       E       F       G       H       I       K       L       M       N       P       Q       R       S       T       V       W       Y
  {   3.93f, -0.41f, -1.75f, -0.86f, -2.21f,  0.16f, -1.63f, -1.32f, -0.73f, -1.46f, -0.94f, -1.53f, -0.81f, -0.80f, -1.41f,  1.12f, -0.05f, -0.19f, -2.53f, -1.76f,  }, // A 
  {  -0.41f,  8.58f, -3.46f, -3.61f, -2.38f, -2.50f, -2.99f, -1.23f, -3.04f, -1.28f, -1.42f, -2.66f, -2.80f, -2.90f, -3.39f, -0.88f, -0.87f, -0.81f, -2.30f, -2.41f,  }, // C 
  {  -1.75f, -3.46f,  5.77f,  1.51f, -3.48f, -1.31f, -1.12f, -3.12f, -0.70f, -3.61f, -3.06f,  1.27f, -1.48f, -0.31f, -1.61f, -0.26f, -1.05f, -3.14f, -4.21f, -3.06f,  }, // D 
  {  -0.86f, -3.61f,  1.51f,  4.90f, -3.19f, -2.11f, -0.12f, -3.19f,  0.78f, -2.85f, -2.00f, -0.27f, -1.12f,  1.85f, -0.12f, -0.15f, -0.86f, -2.44f, -2.84f, -2.02f,  }, // E 
  {  -2.21f, -2.38f, -3.48f, -3.19f,  6.05f, -3.11f, -1.23f, -0.16f, -3.08f,  0.41f,  0.01f, -2.99f, -3.60f, -3.16f, -2.79f, -2.37f, -2.11f, -0.85f,  0.92f,  2.94f,  }, // F 
  {   0.16f, -2.50f, -1.31f, -2.11f, -3.11f,  5.56f, -2.04f, -3.72f, -1.53f, -3.63f, -2.68f, -0.42f, -2.13f, -1.79f, -2.30f, -0.29f, -1.58f, -3.14f, -2.49f, -3.04f,  }, // G 
  {  -1.63f, -2.99f, -1.12f, -0.12f, -1.23f, -2.04f,  7.51f, -3.23f, -0.72f, -2.79f, -1.55f,  0.58f, -2.16f,  0.45f, -0.25f, -0.88f, -1.69f, -3.12f, -2.34f,  1.69f,  }, // H 
  {  -1.32f, -1.23f, -3.12f, -3.19f, -0.16f, -3.72f, -3.23f,  4.00f, -2.67f,  1.52f,  1.13f, -3.22f, -2.76f, -2.77f, -2.99f, -2.35f, -0.72f,  2.55f, -2.58f, -1.33f,  }, // I 
  {  -0.73f, -3.04f, -0.70f,  0.78f, -3.08f, -1.53f, -0.72f, -2.67f,  4.50f, -2.45f, -1.35f, -0.18f, -1.01f,  1.27f,  2.11f, -0.20f, -0.67f, -2.26f, -2.96f, -1.82f,  }, // K 
  {  -1.46f, -1.28f, -3.61f, -2.85f,  0.41f, -3.63f, -2.79f,  1.52f, -2.45f,  3.85f,  1.99f, -3.38f, -2.86f, -2.13f, -2.15f, -2.44f, -1.20f,  0.79f, -1.63f, -1.06f,  }, // L 
  {  -0.94f, -1.42f, -3.06f, -2.00f,  0.01f, -2.68f, -1.55f,  1.13f, -1.35f,  1.99f,  5.39f, -2.15f, -2.48f, -0.42f, -1.37f, -1.48f, -0.67f,  0.69f, -1.42f, -0.99f,  }, // M 
  {  -1.53f, -2.66f,  1.27f, -0.27f, -2.99f, -0.42f,  0.58f, -3.22f, -0.18f, -3.38f, -2.15f,  5.65f, -2.00f,  0.00f, -0.44f,  0.60f, -0.05f, -2.88f, -3.70f, -2.08f,  }, // N 
  {  -0.81f, -2.80f, -1.48f, -1.12f, -3.60f, -2.13f, -2.16f, -2.76f, -1.01f, -2.86f, -2.48f, -2.00f,  7.36f, -1.28f, -2.11f, -0.81f, -1.08f, -2.35f, -3.65f, -2.92f,  }, // P 
  {  -0.80f, -2.90f, -0.31f,  1.85f, -3.16f, -1.79f,  0.45f, -2.77f,  1.27f, -2.13f, -0.42f,  0.00f, -1.28f,  5.29f,  0.98f, -0.10f, -0.68f, -2.20f, -1.95f, -1.42f,  }, // Q 
  {  -1.41f, -3.39f, -1.61f, -0.12f, -2.79f, -2.30f, -0.25f, -2.99f,  2.11f, -2.15f, -1.37f, -0.44f, -2.11f,  0.98f,  5.47f, -0.76f, -1.12f, -2.50f, -2.68f, -1.69f,  }, // R 
  {   1.12f, -0.88f, -0.26f, -0.15f, -2.37f, -0.29f, -0.88f, -2.35f, -0.20f, -2.44f, -1.48f,  0.60f, -0.81f, -0.10f, -0.76f,  3.88f,  1.38f, -1.65f, -2.75f, -1.69f,  }, // S 
  {  -0.05f, -0.87f, -1.05f, -0.86f, -2.11f, -1.58f, -1.69f, -0.72f, -0.67f, -1.20f, -0.67f, -0.05f, -1.08f, -0.68f, -1.12f,  1.38f,  4.55f, -0.06f, -2.43f, -1.61f,  }, // T 
  {  -0.19f, -0.81f, -3.14f, -2.44f, -0.85f, -3.14f, -3.12f,  2.55f, -2.26f,  0.79f,  0.69f, -2.88f, -2.35f, -2.20f, -2.50f, -1.65f, -0.06f,  3.77f, -2.83f, -1.21f,  }, // V 
  {  -2.53f, -2.30f, -4.21f, -2.84f,  0.92f, -2.49f, -2.34f, -2.58f, -2.96f, -1.63f, -1.42f, -3.70f, -3.65f, -1.95f, -2.68f, -2.75f, -2.43f, -2.83f, 10.50f,  2.15f,  }, // W 
  {  -1.76f, -2.41f, -3.06f, -2.02f,  2.94f, -3.04f,  1.69f, -1.33f, -1.82f, -1.06f, -0.99f, -2.08f, -2.92f, -1.42f, -1.69f, -1.69f, -1.61f, -1.21f,  2.15f,  6.59f,  }, // Y 
};

/***
This alphabet is the one used by BLAST.
It includes wildcards (BZX) and stop codon (*).
This substitution matrix is used when alignments are constructed,
see uses of g_SubstMx.
The alphabet for word-counting is different, it has only the 20
standard amino acids. 
Keeping the word-counting alphabet smaller saves memory for
word index tables.
***/
static char Alphabet[] = "*ACBEDGFIHKMLNQPSRTWVYXZ";

// Ye olde BLOSUM62 as used by NCBI BLAST (1/2-bit units)
static float BLOSUM62[24][24] =
	{
//	    *    A    C    B    E    D    G    F    I    H    K    M    L    N    Q    P    S    R    T    W    V    Y    X    Z   
	{   1,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  -4,  },  // *
	{  -4,   4,   0,  -2,  -1,  -2,   0,  -2,  -1,  -2,  -1,  -1,  -1,  -2,  -1,  -1,   1,  -1,   0,  -3,   0,  -2,   0,  -1,  },  // A
	{  -4,   0,   9,  -3,  -4,  -3,  -3,  -2,  -1,  -3,  -3,  -1,  -1,  -3,  -3,  -3,  -1,  -3,  -1,  -2,  -1,  -2,  -2,  -3,  },  // C
	{  -4,  -2,  -3,   4,   1,   4,  -1,  -3,  -3,   0,   0,  -3,  -4,   3,   0,  -2,   0,  -1,  -1,  -4,  -3,  -3,  -1,   1,  },  // B
	{  -4,  -1,  -4,   1,   5,   2,  -2,  -3,  -3,   0,   1,  -2,  -3,   0,   2,  -1,   0,   0,  -1,  -3,  -2,  -2,  -1,   4,  },  // E
	{  -4,  -2,  -3,   4,   2,   6,  -1,  -3,  -3,  -1,  -1,  -3,  -4,   1,   0,  -1,   0,  -2,  -1,  -4,  -3,  -3,  -1,   1,  },  // D
	{  -4,   0,  -3,  -1,  -2,  -1,   6,  -3,  -4,  -2,  -2,  -3,  -4,   0,  -2,  -2,   0,  -2,  -2,  -2,  -3,  -3,  -1,  -2,  },  // G
	{  -4,  -2,  -2,  -3,  -3,  -3,  -3,   6,   0,  -1,  -3,   0,   0,  -3,  -3,  -4,  -2,  -3,  -2,   1,  -1,   3,  -1,  -3,  },  // F
	{  -4,  -1,  -1,  -3,  -3,  -3,  -4,   0,   4,  -3,  -3,   1,   2,  -3,  -3,  -3,  -2,  -3,  -1,  -3,   3,  -1,  -1,  -3,  },  // I
	{  -4,  -2,  -3,   0,   0,  -1,  -2,  -1,  -3,   8,  -1,  -2,  -3,   1,   0,  -2,  -1,   0,  -2,  -2,  -3,   2,  -1,   0,  },  // H
	{  -4,  -1,  -3,   0,   1,  -1,  -2,  -3,  -3,  -1,   5,  -1,  -2,   0,   1,  -1,   0,   2,  -1,  -3,  -2,  -2,  -1,   1,  },  // K
	{  -4,  -1,  -1,  -3,  -2,  -3,  -3,   0,   1,  -2,  -1,   5,   2,  -2,   0,  -2,  -1,  -1,  -1,  -1,   1,  -1,  -1,  -1,  },  // M
	{  -4,  -1,  -1,  -4,  -3,  -4,  -4,   0,   2,  -3,  -2,   2,   4,  -3,  -2,  -3,  -2,  -2,  -1,  -2,   1,  -1,  -1,  -3,  },  // L
	{  -4,  -2,  -3,   3,   0,   1,   0,  -3,  -3,   1,   0,  -2,  -3,   6,   0,  -2,   1,   0,   0,  -4,  -3,  -2,  -1,   0,  },  // N
	{  -4,  -1,  -3,   0,   2,   0,  -2,  -3,  -3,   0,   1,   0,  -2,   0,   5,  -1,   0,   1,  -1,  -2,  -2,  -1,  -1,   3,  },  // Q
	{  -4,  -1,  -3,  -2,  -1,  -1,  -2,  -4,  -3,  -2,  -1,  -2,  -3,  -2,  -1,   7,  -1,  -2,  -1,  -4,  -2,  -3,  -2,  -1,  },  // P
	{  -4,   1,  -1,   0,   0,   0,   0,  -2,  -2,  -1,   0,  -1,  -2,   1,   0,  -1,   4,  -1,   1,  -3,  -2,  -2,   0,   0,  },  // S
	{  -4,  -1,  -3,  -1,   0,  -2,  -2,  -3,  -3,   0,   2,  -1,  -2,   0,   1,  -2,  -1,   5,  -1,  -3,  -3,  -2,  -1,   0,  },  // R
	{  -4,   0,  -1,  -1,  -1,  -1,  -2,  -2,  -1,  -2,  -1,  -1,  -1,   0,  -1,  -1,   1,  -1,   5,  -2,   0,  -2,   0,  -1,  },  // T
	{  -4,  -3,  -2,  -4,  -3,  -4,  -2,   1,  -3,  -2,  -3,  -1,  -2,  -4,  -2,  -4,  -3,  -3,  -2,  11,  -3,   2,  -2,  -3,  },  // W
	{  -4,   0,  -1,  -3,  -2,  -3,  -3,  -1,   3,  -3,  -2,   1,   1,  -3,  -2,  -2,  -2,  -3,   0,  -3,   4,  -1,  -1,  -2,  },  // V
	{  -4,  -2,  -2,  -3,  -2,  -3,  -3,   3,  -1,   2,  -2,  -1,  -1,  -2,  -1,  -3,  -2,  -2,  -2,   2,  -1,   7,  -1,  -2,  },  // Y
	{  -4,   0,  -2,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -2,   0,  -1,   0,  -2,  -1,  -1,  -1,  -1,  },  // X
	{  -4,  -1,  -3,   1,   4,   1,  -2,  -3,  -3,   0,   1,  -1,  -3,   0,   3,  -1,   0,   0,  -1,  -3,  -2,  -2,  -1,   4,  },  // Z
	};

// Ye olde BLOSUM62 as used by NCBI BLAST (1/2-bit units)
// alphabetical order, no wildcards or stop codon
int Blosum62_int[20][20] = {
// A    C    D    E    F    G    H    I    K    L    M    N    P    Q    R    S    T    V    W    Y
{  4,   0,  -2,  -1,  -2,   0,  -2,  -1,  -1,  -1,  -1,  -2,  -1,  -1,  -1,   1,   0,   0,  -3,  -2, }, // A
{  0,   9,  -3,  -4,  -2,  -3,  -3,  -1,  -3,  -1,  -1,  -3,  -3,  -3,  -3,  -1,  -1,  -1,  -2,  -2, }, // C
{ -2,  -3,   6,   2,  -3,  -1,  -1,  -3,  -1,  -3,  -4,   1,  -1,   0,  -2,   0,  -1,  -3,  -4,  -3, }, // D
{ -1,  -4,   2,   5,  -3,  -2,   0,  -3,   1,  -2,  -3,   0,  -1,   2,   0,   0,  -1,  -2,  -3,  -2, }, // E
{ -2,  -2,  -3,  -3,   6,  -3,  -1,   0,  -3,   0,   0,  -3,  -4,  -3,  -3,  -2,  -2,  -1,   1,   3, }, // F
{  0,  -3,  -1,  -2,  -3,   6,  -2,  -4,  -2,  -3,  -4,   0,  -2,  -2,  -2,   0,  -2,  -3,  -2,  -3, }, // G
{ -2,  -3,  -1,   0,  -1,  -2,   8,  -3,  -1,  -2,  -3,   1,  -2,   0,   0,  -1,  -2,  -3,  -2,   2, }, // H
{ -1,  -1,  -3,  -3,   0,  -4,  -3,   4,  -3,   1,   2,  -3,  -3,  -3,  -3,  -2,  -1,   3,  -3,  -1, }, // I
{ -1,  -3,  -1,   1,  -3,  -2,  -1,  -3,   5,  -1,  -2,   0,  -1,   1,   2,   0,  -1,  -2,  -3,  -2, }, // K
{ -1,  -1,  -3,  -2,   0,  -3,  -2,   1,  -1,   5,   2,  -2,  -2,   0,  -1,  -1,  -1,   1,  -1,  -1, }, // L
{ -1,  -1,  -4,  -3,   0,  -4,  -3,   2,  -2,   2,   4,  -3,  -3,  -2,  -2,  -2,  -1,   1,  -2,  -1, }, // M
{ -2,  -3,   1,   0,  -3,   0,   1,  -3,   0,  -2,  -3,   6,  -2,   0,   0,   1,   0,  -3,  -4,  -2, }, // N
{ -1,  -3,  -1,  -1,  -4,  -2,  -2,  -3,  -1,  -2,  -3,  -2,   7,  -1,  -2,  -1,  -1,  -2,  -4,  -3, }, // P
{ -1,  -3,   0,   2,  -3,  -2,   0,  -3,   1,   0,  -2,   0,  -1,   5,   1,   0,  -1,  -2,  -2,  -1, }, // Q
{ -1,  -3,  -2,   0,  -3,  -2,   0,  -3,   2,  -1,  -2,   0,  -2,   1,   5,  -1,  -1,  -3,  -3,  -2, }, // R
{  1,  -1,   0,   0,  -2,   0,  -1,  -2,   0,  -1,  -2,   1,  -1,   0,  -1,   4,   1,  -2,  -3,  -2, }, // S
{  0,  -1,  -1,  -1,  -2,  -2,  -2,  -1,  -1,  -1,  -1,   0,  -1,  -1,  -1,   1,   5,   0,  -2,  -2, }, // T
{  0,  -1,  -3,  -2,  -1,  -3,  -3,   3,  -2,   1,   1,  -3,  -2,  -2,  -3,  -2,   0,   4,  -3,  -1, }, // V
{ -3,  -2,  -4,  -3,   1,  -2,  -2,  -3,  -3,  -1,  -2,  -4,  -4,  -2,  -3,  -3,  -2,  -3,  11,   2, }, // W
{ -2,  -2,  -3,  -2,   3,  -3,   2,  -1,  -2,  -1,  -1,  -2,  -3,  -1,  -2,  -2,  -2,  -1,   2,   7, }, // Y
};

void SetBLOSUM62Mx(Mx<float> &Sf)
	{
	unsigned N = unsigned(strlen(Alphabet));

	Sf.Alloc(256, 256, __FILE__, __LINE__);
	Sf.Init(0);
	float **Data = Sf.GetData();

	for (unsigned i = 0; i < N; ++i)
		{
		for (unsigned j = 0; j < N; ++j)
			{
			float v = BLOSUM62[i][j];
			
			byte ui = (byte) toupper(Alphabet[i]);
			byte uj = (byte) toupper(Alphabet[j]);
			byte li = (byte) tolower(ui);
			byte lj = (byte) tolower(uj);
			ui = (byte) toupper(ui);
			uj = (byte) toupper(uj);

			Data[ui][uj] = v;
			Data[uj][ui] = v;

			Data[ui][lj] = v;
			Data[uj][li] = v;

			Data[li][uj] = v;
			Data[lj][ui] = v;

			Data[li][lj] = v;
			Data[lj][li] = v;
			}
		}
	}

void SetBLOSUM62()
	{
	static mutex Lock;
	Lock.lock();
	if (g_SubstMx == 0)
		{
		SetBLOSUM62Mx(g_SubstMxf);
		g_SubstMx = g_SubstMxf.GetData();
		}
	Lock.unlock();
	}

float GetBlosum62Score(char a, char b)
	{
	static bool InitDone = false;
	if (!InitDone)
		{
		SetBLOSUM62();
		InitDone = true;
		}

	float Score = g_SubstMx[(byte) a][(byte) b];
	return Score;
	}

float GetBlosum62PathScore(
  const string &A, uint LoA,
  const string &B, uint LoB,
  const string &Path)
	{
	const float Open = -10;
	const float Ext = -1;
	float Sum = 0;
	uint LA = SIZE(A);
	uint LB = SIZE(B);
	uint PosA = LoA;
	uint PosB = LoB;
	const uint ColCount = SIZE(Path);
	for (uint Col = 0; Col < ColCount; ++Col)
		{
		char c = Path[Col];
		switch (c)
			{
		case 'M':
			{
			char a = A[PosA];
			char b = B[PosB];
			Sum += GetBlosum62Score(a, b);
			++PosA;
			++PosB;
			break;
			}

		case 'D':
			if (Col != 0 && Path[Col-1] == 'D')
				Sum += Ext;
			else
				Sum += Open;
			++PosA;
			break;

		case 'I':
			if (Col != 0 && Path[Col-1] == 'I')
				Sum += Ext;
			else
				Sum += Open;
			++PosB;
			break;

		default:
			asserta(false);
			}
		}
	asserta(PosA <= SIZE(A));
	asserta(PosB <= SIZE(B));
	return Sum;
	}

float GetBlastpEvalue(float Score, uint QL, float DBSize)
	{
	const float Lambda = 0.267f;
	const float K = 0.0410f;
	static const float Log2 = logf(2.0f);
	float BitScore = (Score*Lambda - K)/Log2;
	float NM = float(QL)*float(DBSize);
	float Evalue = NM/powf(2, BitScore);
	return Evalue;
	}
